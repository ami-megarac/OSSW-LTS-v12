--- linux_patch041/kernel/events/core.c	2021-04-09 10:05:03.960012380 +0800
+++ linux/kernel/events/core.c	2021-04-09 14:19:39.028692028 +0800
@@ -5617,8 +5617,6 @@
 		mutex_unlock(&event->mmap_mutex);
 	}
 
-	atomic_dec(&rb->mmap_count);
-
 	if (!atomic_dec_and_mutex_lock(&event->mmap_count, &event->mmap_mutex))
 		goto out_put;
 
@@ -5626,7 +5624,7 @@
 	mutex_unlock(&event->mmap_mutex);
 
 	/* If there's still other mmap()s of this buffer, we're done. */
-	if (atomic_read(&rb->mmap_count))
+	if (!atomic_dec_and_test(&rb->mmap_count))
 		goto out_put;
 
 	/*
