--- linux_patch035/kernel/trace/ring_buffer.c	2021-02-01 14:03:33.484486532 +0800
+++ linux/kernel/trace/ring_buffer.c	2021-02-01 16:30:07.262648561 +0800
@@ -4406,6 +4406,9 @@
 	if (!cpumask_test_cpu(cpu, buffer->cpumask))
 		return;
 
+	/* prevent another thread from changing buffer sizes */
+	mutex_lock(&buffer->mutex);
+
 	atomic_inc(&buffer->resize_disabled);
 	atomic_inc(&cpu_buffer->record_disabled);
 
@@ -4428,6 +4431,8 @@
 
 	atomic_dec(&cpu_buffer->record_disabled);
 	atomic_dec(&buffer->resize_disabled);
+
+	mutex_unlock(&buffer->mutex);
 }
 EXPORT_SYMBOL_GPL(ring_buffer_reset_cpu);
 
